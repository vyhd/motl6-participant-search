<!doctype html>
<html lang="en">
<head>
  <meta charset="utf8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <title>MotL 6 Participant Search</title>
</head>
<body>
  <label for="participantList" class="form-label">
    Participant Search
  </label>
  <input id="participantList" class="form-control" list="participants" placeholder="Search participants...">
  <datalist id="participants"></datalist>

  <table class="table table-striped" id="participantEvents">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Day</th>
      <th scope="col">Time</th>
      <th scope="col">Category</th>
      <th scope="col">Event</th>
    </tr>
  </thead>
  <tbody id="eventTbody"></tbody>
  </table>

  <div class="spinner-border" role="status" id="participantSpinner" hidden="">
    <span class="visually-hidden">Loading...</span>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
  <script src="index.js"></script>

  <script type="text/javascript">
    const inputNode = document.getElementById("participantList");
    const participantsNode = document.getElementById("participants");
    const spinnerNode = document.getElementById("participantSpinner");
    const tableNode = document.getElementById("participantEvents")

    function setParticipants(participants) {
      /* Given an array of participants, load them into the DOM. */
      console.debug("setParticipants", participants);
      const childNodes = participants.map((n) => new Option(n, n));
      participantsNode.replaceChildren(...childNodes);
    }

    function setEvent(event) {
      console.debug("setEvent", event);
      inputNode.value = event["name"];

      const newTbody = document.createElement("tbody");
      event["events"].forEach((ev) => {
        let newRow = newTbody.insertRow();
        for (const key of ["day", "time", "category", "event"]) {
          newRow.insertCell().textContent = ev[key];
        }
      })

      tableNode.querySelector("tbody").remove();
      tableNode.appendChild(newTbody);
      spinnerNode.hidden = true;
    }

    let client = new ParticipantClient(setParticipants, setEvent);

    async function doUpdate() {
      console.debug("update()")
      await client.update();
    }

    document.addEventListener('DOMContentLoaded', doUpdate);

    // iOS handles datalists horribly, so we manually keep results low by having the user type in
    // at least one character before we populate the participants list.

    inputNode.addEventListener("input", (event) => {
      let name = inputNode.value;
      console.debug("input", event, name);
      if (name.length > 0) {
        const matches = client.participants.filter((n) => n.toLowerCase().startsWith(name));
        setParticipants(matches);
      }

      if (client.participants.includes(inputNode.value)) {
        console.debug("name matches, doing fetch")
        spinnerNode.hidden = false;
        client.fetchEvents(inputNode.value);
      }
    })
  </script>
</body>
</html>
